Adapted from ELK code http://elk.sourceforge.net/